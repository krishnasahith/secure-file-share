<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔐 Secure File Share</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div id="auth-modal" class="modal-overlay">
        <div class="auth-modal">
            <span class="security-icon">🔐</span>
            <h2>Secure Connection Required</h2>
            <p>Enter the connection code displayed on the server</p>
            <div class="input-group">
                <input type="text" id="code-input" placeholder="Enter connection code" 
                       maxlength="8" autocomplete="off" style="text-transform: uppercase;">
                <button id="connect-btn" class="primary-btn">Connect</button>
            </div>
            <div id="auth-error" class="error-message"></div>
        </div>
    </div>

    <div id="main-content">
        <div class="container">
            <div class="header">
                <div class="logo">
                    <span class="logo-icon">🔒</span>
                    <h1>Secure File Share</h1>
                </div>
                <button id="disconnect-btn" class="disconnect-btn">Disconnect</button>
            </div>

            <div class="upload-section">
                <h2>📤 Upload Files</h2>
                <div class="drop-zone" id="drop-zone">
                    <input type="file" id="file-input" hidden>
                    <span class="upload-icon">📁</span>
                    <p>Drag & drop files here</p>
                    <span>or</span>
                    <button class="secondary-btn" id="browse-btn">click to browse</button>
                </div>
                <div id="upload-status" class="status-message"></div>
            </div>

            <div class="files-section">
                <h2>📂 Available Files</h2>
                <div id="files-list" class="files-list">
                    <p class="empty-state">No files uploaded yet</p>
                </div>
            </div>
        </div>
    </div>

        <script>
        // Authentication
        let isAuthenticated = false;

        // Handle deep links with auth code
        function handleDeepLink() {
            const hash = window.location.hash;
            if (hash && hash.startsWith('#code=')) {
                const code = hash.replace('#code=', '');
                document.getElementById('code-input').value = code;
                // Remove the code from URL for security
                window.location.hash = '';
                // Try to authenticate
                document.getElementById('connect-btn').click();
            }
        }

        // Show auth modal immediately on page load
        document.addEventListener('DOMContentLoaded', function() {
            showAuthModal();
            handleDeepLink();
        });

        async function checkSession() {
            try {
                const response = await fetch('/session-status', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Session check failed');
                }
                
                isAuthenticated = data.authenticated;
                
                if (isAuthenticated) {
                    showMainContent();
                    loadFiles();
                } else {
                    showAuthModal();
                    if (data.error === 'Session expired') {
                        document.getElementById('auth-error').textContent = 'Session expired. Please reconnect.';
                    }
                }
            } catch (error) {
                isAuthenticated = false;
                showAuthModal();
                document.getElementById('auth-error').textContent = error.message || 'Connection error';
            }
        }        function showAuthModal() {
            document.getElementById('auth-modal').style.display = 'flex';
            document.getElementById('main-content').style.display = 'none';
        }

        function showMainContent() {
            document.getElementById('auth-modal').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
        }

        document.getElementById('connect-btn').addEventListener('click', async () => {
            const code = document.getElementById('code-input').value.trim().toUpperCase();
            const errorDiv = document.getElementById('auth-error');
            
            if (!code) {
                errorDiv.textContent = 'Please enter a connection code';
                return;
            }

            try {
                const response = await fetch('/authenticate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    credentials: 'include',
                    body: JSON.stringify({ code })
                });

                const data = await response.json();

                if (data.success) {
                    isAuthenticated = true;
                    showMainContent();
                    loadFiles();
                } else {
                    errorDiv.textContent = data.message || 'Invalid connection code';
                }
            } catch (error) {
                errorDiv.textContent = 'Connection failed. Please try again.';
            }
        });

        document.getElementById('disconnect-btn').addEventListener('click', async () => {
            try {
                await fetch('/disconnect', {
                    method: 'POST',
                    credentials: 'include'
                });
                isAuthenticated = false;
                showAuthModal();
                document.getElementById('code-input').value = '';
                document.getElementById('auth-error').textContent = '';
            } catch (error) {
                console.error('Disconnect failed:', error);
            }
        });

        // File upload
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const browseBtn = document.getElementById('browse-btn');

        browseBtn.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                uploadFile(files);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                uploadFile(e.target.files);
            }
        });

        async function uploadFile(files) {
            const statusDiv = document.getElementById('upload-status');
            const file = files[0];  // Handle first file for now
            const formData = new FormData();
            formData.append('file', file);

            statusDiv.textContent = `Uploading ${file.name}...`;
            statusDiv.className = 'status-message';

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    statusDiv.textContent = `✓ ${file.name} uploaded successfully`;
                    statusDiv.classList.add('success');
                    fileInput.value = '';
                    setTimeout(() => {
                        statusDiv.textContent = '';
                        loadFiles();
                    }, 3000);
                } else {
                    statusDiv.textContent = `✗ ${data.error}`;
                    statusDiv.classList.add('error');
                }
            } catch (error) {
                statusDiv.textContent = '✗ Upload failed';
                statusDiv.classList.add('error');
            }
        }

        // File listing
        async function loadFiles() {
            try {
                const response = await fetch('/files', {
                    credentials: 'include'
                });
                const data = await response.json();

                const filesList = document.getElementById('files-list');
                
                if (data.files && data.files.length > 0) {
                    filesList.innerHTML = data.files.map(file => `
                        <div class="file-item">
                            <div class="file-info">
                                <span class="file-icon">${getFileIcon(file.name)}</span>
                                <div class="file-details">
                                    <div class="file-name">${file.name}</div>
                                    <div class="file-meta">${formatFileSize(file.size)}</div>
                                </div>
                            </div>
                            <div class="file-actions">
                                <button class="action-btn download-btn" onclick="downloadFile('${file.name}')">⬇️ Download</button>
                                <button class="action-btn delete-btn" onclick="deleteFile('${file.name}')">🗑️ Delete</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    filesList.innerHTML = '<p class="empty-state">No files uploaded yet</p>';
                }
            } catch (error) {
                console.error('Failed to load files:', error);
            }
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                pdf: '📄', doc: '📝', docx: '📝', txt: '📃',
                jpg: '🖼️', jpeg: '🖼️', png: '🖼️', gif: '🖼️',
                mp4: '🎥', avi: '🎥', mov: '🎥',
                mp3: '🎵', wav: '🎵',
                zip: '📦', rar: '📦', '7z': '📦'
            };
            return icons[ext] || '📄';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function downloadFile(filename) {
            window.location.href = `/download/${encodeURIComponent(filename)}`;
        }

        async function deleteFile(filename) {
            if (!confirm(`Delete ${filename}?`)) return;

            try {
                const response = await fetch(`/delete/${encodeURIComponent(filename)}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const data = await response.json();

                if (data.success) {
                    loadFiles();
                } else {
                    alert(`Failed to delete: ${data.error}`);
                }
            } catch (error) {
                alert('Delete failed');
            }
        }

        // Enter key for authentication
        document.getElementById('code-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('connect-btn').click();
            }
        });

        // Auto-format connection code input
        document.getElementById('code-input').addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
        });

        // Initialize page based on authentication
        function initializePage() {
            if (!isAuthenticated) {
                document.getElementById('auth-modal').classList.remove('hidden');
                document.getElementById('main-content').style.display = 'none';
            } else {
                document.getElementById('auth-modal').classList.add('hidden');
                document.getElementById('main-content').style.display = 'block';
                loadFiles();
            }
        }

        // Check session and authentication on load
        checkSession();
        
        // Add a global AJAX error handler for authentication
        document.addEventListener('ajaxError', function(e) {
            if (e.detail.status === 401) {
                isAuthenticated = false;
                showAuthModal();
            }
        });
    </script>
</body>
</html>
